@startuml Identity-Auth Service - MFA Verify
skinparam fontName "Helvetica"
skinparam titleFontName "Helvetica"
skinparam legendFontName "Helvetica"
skinparam noteFontName "Helvetica"
autonumber
actor Client as Client
participant "AuthController" as Controller
participant "VerifyMfaUseCase" as VerifyMfaUC
participant "MfaRepository" as MfaRepo
participant "TotpService" as Totp
participant "UserRepository" as UserRepo
participant "Azure Key Vault" as KV

Client -> Controller: POST /auth/mfa/verify { code }\n(Authorization: bearer)
Controller -> VerifyMfaUC: verify(userId, code)
VerifyMfaUC -> MfaRepo: get(userId)
MfaRepo --> VerifyMfaUC: MfaSecret
VerifyMfaUC -> Totp: verifyCode(secretEnc, code)
Totp -> KV: decrypt secret
KV --> Totp: plaintext secret
Totp --> VerifyMfaUC: boolean
alt correct code
VerifyMfaUC -> MfaRepo: verify(userId)
VerifyMfaUC -> UserRepo: save(mfaEnabled=true)
VerifyMfaUC --> Controller: 204
Controller --> Client: 204
else invalid code
VerifyMfaUC --> Controller: 400
Controller --> Client: 400
end
@enduml
