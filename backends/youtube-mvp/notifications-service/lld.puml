@startuml
title Notifications Service - LLD

skinparam shadowing false
skinparam packageStyle rectangle
skinparam classAttributeIconSize 0
skinparam fontName "Helvetica"
skinparam titleFontName "Helvetica"
skinparam legendFontName "Helvetica"
skinparam noteFontName "Helvetica"
skinparam backgroundColor white
skinparam packageBackgroundColor lightblue
skinparam packageBorderColor darkblue
skinparam classBackgroundColor white
skinparam classBorderColor black
skinparam interfaceBackgroundColor lightgreen
skinparam interfaceBorderColor black
skinparam enumBackgroundColor lightyellow
skinparam enumBorderColor black
skinparam arrowColor black
skinparam arrowThickness 2


package "NotificationsService" {
class NotificationConsumer {
+onNewVideoNotificationRequested(event)
+onCommentPosted(event)
}

class NotificationService {
+sendInApp(userId, payload)
+sendPush(deviceToken, payload)
+sendEmail(to, subject, body)
}

class DeliveryRepository {
+recordAttempt(notificationId, channel, status)
+getState(notificationId): DeliveryState
}

class DeliveryState {
-notificationId: UUID
-attempts: int
-status: String
}

interface PushAdapter {
+send(deviceToken, payload)
}

interface EmailAdapter {
+send(to, subject, body)
}
class TemplateRenderer {
+render(name, model): String
}
class OutboxEventPublisher {
+publish(event: DomainEvent)
}
class DomainEvent {}
}

package "Azure Integrations" {
class CosmosDB
class AzureCommunicationServices
class PushProvider
class AzureServiceBusTopic
}

NotificationConsumer --> NotificationService
NotificationService --> DeliveryRepository
NotificationService --> PushAdapter
NotificationService --> EmailAdapter
NotificationService --> TemplateRenderer
DeliveryRepository ..> CosmosDB
EmailAdapter ..> AzureCommunicationServices
PushAdapter ..> PushProvider
NotificationService --> OutboxEventPublisher : "NotificationSent / DeliveryFailed"
OutboxEventPublisher ..> AzureServiceBusTopic

@enduml
