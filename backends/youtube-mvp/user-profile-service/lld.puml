@startuml
title User Profile Service - Low-Level Design

skinparam shadowing false
skinparam packageStyle rectangle
skinparam classAttributeIconSize 0
skinparam fontName "Helvetica"
skinparam titleFontName "Helvetica"
skinparam legendFontName "Helvetica"
skinparam noteFontName "Helvetica"
skinparam backgroundColor white
skinparam packageBackgroundColor lightblue
skinparam packageBorderColor darkblue
skinparam classBackgroundColor white
skinparam classBorderColor black
skinparam interfaceBackgroundColor lightgreen
skinparam interfaceBorderColor black
skinparam fontSize 10
skinparam maxMessageSize 60
skinparam linetype ortho

package "Domain Layer" <<clean>> {
    class AccountProfile
    class PrivacySettings
    class NotificationSettings
    class AccessibilityPreferences
    enum CaptionFontSize
    class ProfileUpdated
    class PrivacySettingsChanged
    class NotificationPrefsChanged
    class AccessibilityPrefsChanged
    
    interface ProfileRepository
    interface EventPublisher
    interface CacheService
    interface BlobUriValidator
}

package "Application Layer" <<clean>> {
    interface Saga
    class UpdateProfileSaga
    class UpdateProfileCommand
    class UpdatePrivacySettingsCommand
    class UpdateNotificationSettingsCommand
    class UpdateAccessibilityPreferencesCommand
    class GetProfileQuery
    class GetPrivacySettingsQuery
    class GetNotificationSettingsQuery
    class GetAccessibilityPreferencesQuery
    
    interface ProfileUseCase
    class ProfileUseCaseImpl
}

package "Infrastructure Layer" <<clean>> {
    class ProfileEntity
    class PrivacySettingsEmbeddable
    class NotificationSettingsEmbeddable
    class AccessibilityPreferencesEmbeddable
    class HttpIdempotencyEntity
    
    class ProfileRepositoryImpl
    class EventPublisherImpl
    class CacheServiceImpl
    class BlobUriValidatorImpl
    class UserCreatedEventHandler
    
    class SecurityConfig
    class IdempotencyConfig
    class EventHandlerConfig
    
    note right of ProfileEntity
        DB: userprofile
        Schema: user_profile
        Table: account_profiles
    end note
    
    note right of HttpIdempotencyEntity
        Schema: user_profile
        Table: http_idempotency
    end note
}

package "Interface Layer" <<clean>> {
    class ProfileController
    class ServiceGlobalExceptionHandler
}

package "Common Domain" <<clean>> {
    class CorrelationFilter
    class IdempotencyFilter
    class EventRouter
    class JpaHttpIdempotencyRepository
    class GlobalExceptionHandler
    class UnitOfWork
    class Clock
}

' Core Relationships
ProfileController --> ProfileUseCase
ProfileUseCase <|.. ProfileUseCaseImpl
ProfileUseCaseImpl --> ProfileRepository
ProfileUseCaseImpl --> EventPublisher
ProfileUseCaseImpl --> UnitOfWork
ProfileUseCaseImpl --> Clock
UpdateProfileSaga --> ProfileRepository
UpdateProfileSaga --> EventPublisher
UpdateProfileSaga --> CacheService
UpdateProfileSaga --> BlobUriValidator

' Implementations
ProfileRepository <|.. ProfileRepositoryImpl
EventPublisher <|.. EventPublisherImpl
CacheService <|.. CacheServiceImpl
BlobUriValidator <|.. BlobUriValidatorImpl

' Infrastructure Mappings
ProfileRepositoryImpl --> ProfileEntity
ProfileEntity *-- PrivacySettingsEmbeddable
ProfileEntity *-- NotificationSettingsEmbeddable
ProfileEntity *-- AccessibilityPreferencesEmbeddable
IdempotencyConfig --> HttpIdempotencyEntity
IdempotencyConfig --> JpaHttpIdempotencyRepository

' Domain Events
AccountProfile ..> ProfileUpdated
AccountProfile ..> PrivacySettingsChanged
AccountProfile ..> NotificationPrefsChanged
AccountProfile ..> AccessibilityPrefsChanged

' Common Domain
ProfileController ..> CorrelationFilter
ProfileController ..> IdempotencyFilter
EventPublisherImpl --> EventRouter
ServiceGlobalExceptionHandler --|> GlobalExceptionHandler
EventRouter --> UserCreatedEventHandler
EventHandlerConfig --> EventRouter
UserCreatedEventHandler --> ProfileRepository
UserCreatedEventHandler --> UnitOfWork
UserCreatedEventHandler --> Clock

@enduml
