<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="540px" preserveAspectRatio="none" style="width:854px;height:540px;background:#FFFFFF;" version="1.1" viewBox="0 0 854 540" width="854px" zoomAndPan="magnify"><title>Common-Domain - Optimistic Concurrency Control</title><defs/><g><text fill="#000000" font-family="'Helvetica'" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="341.4619" x="257.7588" y="25.7803">Common-Domain - Optimistic Concurrency Control</text><rect fill="none" height="149.5078" style="stroke:#000000;stroke-width:1.5;" width="837.9795" x="10" y="295.3516"/><g><title>CommandHandler</title><rect fill="#000000" fill-opacity="0.00000" height="359.3711" width="8" x="84.3765" y="102.4883"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="88" x2="88" y1="102.4883" y2="461.8594"/></g><g><title>Repository</title><rect fill="#000000" fill-opacity="0.00000" height="359.3711" width="8" x="318.5928" y="102.4883"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="322.5298" x2="322.5298" y1="102.4883" y2="461.8594"/></g><g><title>Azure SQL</title><rect fill="#000000" fill-opacity="0.00000" height="359.3711" width="8" x="795.8735" y="102.4883"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="799.7676" x2="799.7676" y1="102.4883" y2="461.8594"/></g><g class="participant participant-head" data-participant="Handler"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="136.7529" x="20" y="71"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122.7529" x="27" y="91.5352">CommandHandler</text></g><g class="participant participant-tail" data-participant="Handler"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="136.7529" x="20" y="460.8594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122.7529" x="27" y="481.3945">CommandHandler</text></g><g class="participant participant-head" data-participant="Repo"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="86.126" x="279.5298" y="71"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="72.126" x="286.5298" y="91.5352">Repository</text></g><g class="participant participant-tail" data-participant="Repo"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="86.126" x="279.5298" y="460.8594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="72.126" x="286.5298" y="481.3945">Repository</text></g><g class="participant participant-head" data-participant="SQL"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="70.2119" x="761.7676" y="99.5352">Azure SQL</text><path d="M781.8735,50 C781.8735,40 799.8735,40 799.8735,40 C799.8735,40 817.8735,40 817.8735,50 L817.8735,76 C817.8735,86 799.8735,86 799.8735,86 C799.8735,86 781.8735,86 781.8735,76 L781.8735,50" fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M781.8735,50 C781.8735,60 799.8735,60 799.8735,60 C799.8735,60 817.8735,60 817.8735,50" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="SQL"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="70.2119" x="761.7676" y="474.3945">Azure SQL</text><path d="M781.8735,487.3477 C781.8735,477.3477 799.8735,477.3477 799.8735,477.3477 C799.8735,477.3477 817.8735,477.3477 817.8735,487.3477 L817.8735,513.3477 C817.8735,523.3477 799.8735,523.3477 799.8735,523.3477 C799.8735,523.3477 781.8735,523.3477 781.8735,513.3477 L781.8735,487.3477" fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M781.8735,487.3477 C781.8735,497.3477 799.8735,497.3477 799.8735,497.3477 C799.8735,497.3477 817.8735,497.3477 817.8735,487.3477" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="message" data-participant-1="Handler" data-participant-2="Repo"><polygon fill="#181818" points="310.5928,129.7988,320.5928,133.7988,310.5928,137.7988,314.5928,133.7988" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="88.3765" x2="316.5928" y1="133.7988" y2="133.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="8.5757" x="95.3765" y="129.0566">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="40.606" x="107.9521" y="129.0566">get(id)</text></g><g class="message" data-participant-1="Repo" data-participant-2="SQL"><polygon fill="#181818" points="787.8735,159.1094,797.8735,163.1094,787.8735,167.1094,791.8735,163.1094" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="322.5928" x2="793.8735" y1="163.1094" y2="163.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="8.5757" x="329.5928" y="158.3672">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="303.2275" x="342.1685" y="158.3672">SELECT *, version FROM aggregates WHERE id=?</text></g><g class="message" data-participant-1="SQL" data-participant-2="Repo"><polygon fill="#181818" points="333.5928,188.4199,323.5928,192.4199,333.5928,196.4199,329.5928,192.4199" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="327.5928" x2="798.8735" y1="192.4199" y2="192.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="8.5757" x="339.5928" y="187.6777">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100.2549" x="352.1685" y="187.6777">Aggregate(v=N)</text></g><g class="message" data-participant-1="Repo" data-participant-2="Handler"><polygon fill="#181818" points="99.3765,217.7305,89.3765,221.7305,99.3765,225.7305,95.3765,221.7305" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="93.3765" x2="321.5928" y1="221.7305" y2="221.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="8.5757" x="105.3765" y="216.9883">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="60.3027" x="117.9521" y="216.9883">Agg(v=N)</text></g><g class="message" data-participant-1="Handler" data-participant-2="Repo"><polygon fill="#181818" points="310.5928,247.041,320.5928,251.041,310.5928,255.041,314.5928,251.041" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="88.3765" x2="316.5928" y1="251.041" y2="251.041"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="8.5757" x="95.3765" y="246.2988">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197.6406" x="107.9521" y="246.2988">save(Agg', expectedVersion=N)</text></g><g class="message" data-participant-1="Repo" data-participant-2="SQL"><polygon fill="#181818" points="787.8735,276.3516,797.8735,280.3516,787.8735,284.3516,791.8735,280.3516" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="322.5928" x2="793.8735" y1="280.3516" y2="280.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="8.5757" x="329.5928" y="275.6094">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="440.7051" x="342.1685" y="275.6094">UPDATE aggregates SET ..., version=N+1 WHERE id=? AND version=N</text></g><path d="M10,295.3516 L72.1387,295.3516 L72.1387,302.6621 L62.1387,312.6621 L10,312.6621 L10,295.3516" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="149.5078" style="stroke:#000000;stroke-width:1.5;" width="837.9795" x="10" y="295.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17.1387" x="25" y="308.9199">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="108.8506" x="87.1387" y="307.9863">[rows affected = 1]</text><g class="message" data-participant-1="SQL" data-participant-2="Repo"><polygon fill="#181818" points="333.5928,329.9727,323.5928,333.9727,333.5928,337.9727,329.5928,333.9727" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="327.5928" x2="798.8735" y1="333.9727" y2="333.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="8.5757" x="339.5928" y="329.2305">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15.5835" x="352.1685" y="329.2305">ok</text></g><g class="message" data-participant-1="Repo" data-participant-2="Handler"><polygon fill="#181818" points="99.3765,359.2832,89.3765,363.2832,99.3765,367.2832,95.3765,363.2832" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="93.3765" x2="321.5928" y1="363.2832" y2="363.2832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="8.5757" x="105.3765" y="358.541">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="35.9595" x="117.9521" y="358.541">saved</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="10" x2="847.9795" y1="372.2832" y2="372.2832"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="108.8506" x="15" y="382.918">[rows affected = 0]</text><g class="message" data-participant-1="SQL" data-participant-2="Repo"><polygon fill="#181818" points="333.5928,403.5488,323.5928,407.5488,333.5928,411.5488,329.5928,407.5488" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="327.5928" x2="798.8735" y1="407.5488" y2="407.5488"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="8.5757" x="339.5928" y="402.8066">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46.5283" x="352.1685" y="402.8066">conflict</text></g><g class="message" data-participant-1="Repo" data-participant-2="Handler"><polygon fill="#181818" points="99.3765,432.8594,89.3765,436.8594,99.3765,440.8594,95.3765,436.8594" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="93.3765" x2="321.5928" y1="436.8594" y2="436.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17.1514" x="105.3765" y="432.1172">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140.9497" x="126.5278" y="432.1172">ConcurrencyException</text></g><!--SRC=[XP9DJy9048Rl-oiclOXAYLn9q3HGmW6B0kfvQAVDXkrkixkjuAztMyg7IFJGxCVxp3llDcCsN1QeCOTKIHjXJk1DILHaUOmUCqVPSYjeyZSZA2EP_0D9PQ_xD1rWfF9SIN-iSkGIV9WNbkVSECH9CYwr9XdlwhtLIZ0ihP9blYRDdBsZU87IWbVRe4ocxXEaFK03xVudjw126MwLtZLCVMG9MboZSUc2hr8JB5zdZUXMnbeNy1yRU00PsGvFRbbzgcyTDO1bE0j7AxZhGaNQS2LXifW_0sQPfWmj6VYOXeiGU39yOgu2_ADVS60wrJ0ws3grRTm0U-bN58CLTPnyqmNQ5XHRIjxtxKzERS2tbt6m2iy3BSCLz7gzO-9XTDy_Imb1D3v938K5hJuDO9esZM08_OkNgCsLz7N6X95ml_Uo_k6YFbOo5JosLrpEHY7SnkHcH4dcPkyR]--></g></svg>